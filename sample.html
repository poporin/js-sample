<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <title></title>
    <h3> Photo Viewer </h3>
    <label >1. File input</label>
    <input type="file" id="files" name="files[]" class="file" accept="image/*" />

    <script src="assets/js/libs/pio-client.js"></script>
    <script src="assets/js/libs/jquery-2.1.3.min.js"></script>
    <script src="assets/js/Conf.js"></script>
    <script src="assets/js/model/File.js"></script>
    <script>

        var handleFileSelect = function(evt){
            var selectedFile = evt.target.files[0];
            File.name = selectedFile.name;
            File.type = selectedFile.type;

            var reader = new FileReader();

            reader.onload = (function(theFile) {
                return function(e){
                    File.data =e.target.result;
                }
            })(selectedFile);
//            reader.readAsText(selectedFile);
            reader.readAsArrayBuffer(selectedFile);
        };

        document.getElementById('files').addEventListener('change', handleFileSelect, false);

        var uploadFileToPIO = function() {
            var dcx = new dcc.DcContext(Conf.UNITURL);
            var acc = dcx.asAccount(Conf.CELLNAME , Conf.ACCOUNTNAME, Conf.PASSWORD);
            var cell = acc.cell();

            var uploadFileName = File.name;
            var options = {
                body : File.data,
                headers : {
                    "Content-Type" : File.type,
                    "If-Match" : "*"
                }
            };

            cell.box('piobox').col('col').put(uploadFileName, options);
            //ToDo Fileオブジェクトの中身を削除する必要あり？二回目のアップでも前回選択した画像がアップされてしまうため
        };

        var displayFiles = function(){
            var dcx = new dcc.DcContext(Conf.UNITURL);
            var acc = dcx.asAccount(Conf.CELLNAME , Conf.ACCOUNTNAME, Conf.PASSWORD);
            var cell = acc.cell('',{useCookie: true});
            var cookiePeer = cell.getCookiePeer();
            console.log(cookiePeer);

            //colディレクリのファイルリストを取得する
            var resp = cell.box('piobox').col('col').getFileList();
            console.log(resp);

            var fileUrlArray = [];
            for (var i in resp){
                fileUrlArray[i] = resp[i].Name;
                //ToDo 認証エラーになるのを解決する必要あり
                $('#viewArea').append($('<img/>').attr('src', fileUrlArray[i]));
                console.log(resp[i].Name);
            };
            //ToDo 表示した画像を消す必要あり。VIEWボタンを押すたびに表示画像が増えていく。
        };


        var downloadFileFromPIO = function() {
            var dcx = new dcc.DcContext(Conf.UNITURL);
            var acc = dcx.asAccount(Conf.CELLNAME, Conf.ACCOUNTNAME, Conf.PASSWORD);
            var cell = acc.cell();
            var fileList = cell.box('piobox').col('col').getFileList();
            console.log(fileList[0].Name);

//            var anchor = $("<a></a>",{
//                href :"http://localhost:1210/pio/piobox/col/androidify.png",
//                text : "ImageDownload",
//                download : "file.png",
//                target : "_blank"
//            }).appendTo("body");

            //jqueryで自動ダウンロードボタンが作れないので、ひとまずWindowオブジェクトで対処
            var anchor = document.createElement("a");
            anchor.href = fileList[0].Name;
            anchor.target = "_blank";
            anchor.download = "hoge.png";
            document.body.appendChild(anchor);
            anchor.click();
        };

        $(document).ready(function(){
                    $("#uploadButton").click(
                            function(){
                                uploadFileToPIO();
                            }
                    );
                    $("#displayButton").click(
                            function(){
                                displayFiles();
                            }
                    ),
                    $("#downloadButton").click(
                            function(){
                                downloadFileFromPIO();
                            }
                    )
                }
        );

    </script>
</head>
<body>

<br>
<label >2. File upload</label>
<p>
    <button type="button" id="uploadButton" class="btn btn-default">UPLOAD</button>
</p>
<label >3. File view</label>
<p>
    <button type="button" id="displayButton" class="btn btn-default">DISPLAYLOAD</button>
</p>
<label >4. File download</label>
<p>
    <button type="button" id="downloadButton" class="btn btn-default">DOWNLOAD</button>
</p>

<br>

</body>
</html>